<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Color Sensor NFT Generator</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #0a0a14;
            color: #fff;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        h1 {
            margin-bottom: 5px;
            font-size: 1.5rem;
            color: #888;
        }

        #progress {
            font-size: 1.2rem;
            color: #0ff;
            margin-bottom: 10px;
        }

        #canvas-container {
            position: relative;
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.1);
            border-radius: 50%;
        }

        canvas {
            background-color: #0a0a14;
            border-radius: 50%;
            display: block;
        }

        #status {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #555;
        }

        #color-preview {
            margin-top: 10px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #333;
        }

        #done-message {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #0ff;
            border-radius: 10px;
            text-align: center;
        }

        #done-message h2 {
            color: #0ff;
            margin: 0 0 10px 0;
        }

        #reset-btn {
            margin-top: 15px;
            padding: 10px 20px;
            background: #0ff;
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>Live Color Sensor NFT Generator</h1>
    <div id="progress">0 / 200 samples</div>
    <div id="canvas-container">
        <canvas id="artCanvas" width="800" height="800"></canvas>
    </div>
    <div id="color-preview"></div>
    <div id="status">Waiting for sensor data...</div>

    <div id="done-message">
        <h2>NFT GENERATED!</h2>
        <p>Check the terminal for ElevenLabs announcement</p>
        <p>Art saved to: color_spiral_art.png</p>
        <button id="reset-btn" onclick="resetArt()">Generate New NFT</button>
    </div>

    <script>
        const canvas = document.getElementById('artCanvas');
        const ctx = canvas.getContext('2d');
        const statusEl = document.getElementById('status');
        const progressEl = document.getElementById('progress');
        const colorPreview = document.getElementById('color-preview');
        const doneMessage = document.getElementById('done-message');

        const MAX_POINTS = 200;
        const CENTER_X = canvas.width / 2;
        const CENTER_Y = canvas.height / 2;
        const MAX_RADIUS = (Math.min(canvas.width, canvas.height) / 2) - 40;

        let count = 0;
        let lastCount = -1;

        ctx.fillStyle = "#0a0a14";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        async function fetchData() {
            try {
                const response = await fetch('/data');
                const data = await response.json();

                progressEl.innerText = `${data.count} / ${data.max} samples`;

                if (data.done) {
                    doneMessage.style.display = 'block';
                    statusEl.innerText = "NFT Generated!";
                    return;
                }

                // Draw new point if count increased
                if (data.count > lastCount && data.count <= MAX_POINTS) {
                    lastCount = data.count;
                    statusEl.innerText = `RGB: ${data.r}, ${data.g}, ${data.b}`;
                    drawSpiralPoint(data.count - 1, data.r, data.g, data.b);
                }
            } catch (e) {
                statusEl.innerText = "Connecting...";
            }
        }

        function drawSpiralPoint(index, sensorR, sensorG, sensorB) {
            const t = index / MAX_POINTS;
            const angle = index * 0.8;  // More spread out
            const radius = 10 + (t * MAX_RADIUS);

            const x = CENTER_X + Math.cos(angle) * radius;
            const y = CENTER_Y + Math.sin(angle) * radius;

            const rVal = Math.max(0, Math.min(255, 255 - (sensorR * 1.5)));
            const gVal = Math.max(0, Math.min(255, 255 - (sensorG * 1.5)));
            const bVal = Math.max(0, Math.min(255, 255 - (sensorB * 1.5)));

            const intensity = (sensorR + sensorG + sensorB) / 3;
            const size = Math.max(3, 15 - (intensity / 10));  // Smaller circles

            const color = `rgb(${rVal}, ${gVal}, ${bVal})`;
            colorPreview.style.backgroundColor = color;

            ctx.beginPath();
            ctx.arc(x, y, size, 0, Math.PI * 2);
            ctx.fillStyle = color;
            ctx.shadowBlur = 15;
            ctx.shadowColor = color;
            ctx.fill();
            ctx.shadowBlur = 0;
        }

        async function resetArt() {
            await fetch('/reset');
            ctx.fillStyle = "#0a0a14";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            lastCount = -1;
            doneMessage.style.display = 'none';
            statusEl.innerText = "Waiting for sensor data...";
        }

        setInterval(fetchData, 100);
        fetchData();
    </script>
</body>

</html>